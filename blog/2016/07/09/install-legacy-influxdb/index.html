<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>安装旧版本的 influxdb - Shane Xu&#39;s Home</title>
    <meta charset="utf-8" />
    <meta name="author" content="Shane Xu" />
    <meta name="description" content="install legacy version of influxdb" />
    <meta name="keywords" content="influxdb" />
    <link rel="stylesheet" href="/media/css/org-manual.css" type="text/css">
    <link rel="stylesheet" href="/media/css/extra.css" type="text/css">
    <link rel="stylesheet" href="/media/css/prettify.css" type="text/css"/>
  </head>

  <body>
    <div>
      <header class="masthead">
        <h1 class="settitle">Shane Xu&#39;s Home</h1>
        <blockquote>Life is too short for so much sorrows.</blockquote>
        <form method="get" id="searchform" action="//www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="xusheng.org">
        </form>
      </header>
    </div>
    <div class="node nav">
      <ul>
          <li><a href="/blog/">Blog</a></li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/">About</a></li>
        <li><a href="https://github.com/shanexu">GitHub</a></li>
        <li><a href="/rss.xml">RSS</a></li>
      </ul>
      <hr/>
    </div>


<h3 class="section">安装旧版本的 influxdb</h3>
<p>
因为工作需要，所以接触了 influxdb，而工作中用的 <a href="https://influxdata.com/">influxdb</a> 的版本则是 0.10.2 的版本，官方只提供了最新稳定版的下载。看了官网的角角落落，也没有找到明显的下载地方，那就只有自己编译了。以下内容基本都是 influxdb 源码中 CONTRIBUTING.md 中的内容。
</p>

<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1">安装 Go</h2>
<div class="outline-text-2" id="text-orgheadline1">
<p>
InfluxDB 0.10.2 需要 Go 1.4.3。目前 Go 的稳定版已经跑到 1.6.2 了。和很多语言一样（例如 node 的 nvm, ruby 的 rvm），Go 也出现了版本管理工具 <a href="https://github.com/moovweb/gvm">gvm</a> 。可以用下面命令安装 gvm
</p>
<div class="org-src-container">

<pre class="src src-sh">bash &lt; &lt;(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer)
</pre>
</div>
<p>
如果使用 zsh 的话就把 bash 替换成 zsh。然后安装 Go。
</p>
<div class="org-src-container">

<pre class="src src-sh">gvm install go1.4.2 -B #mac 可能需要先安装 go1.4.2 的 binary 版本
gvm install go1.4.3
gvm use go1.4.3 --default #可以不设置为 default, 下次使用时需要执行这条命令
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline2" class="outline-2">
<h2 id="orgheadline2">安装版本控制系统</h2>
<div class="outline-text-2" id="text-orgheadline2">
<p>
Go 能够通过版本控制系统引入远端的包，目前 influxdb 只依赖于 <code>git</code> 和 <code>mercurial</code>
</p>
</div>
<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3">安装 <a href="http://git-scm.com/book/en/Getting-Started-Installing-Git">Git</a></h3>
<div class="outline-text-3" id="text-orgheadline3">
<div class="org-src-container">

<pre class="src src-sh">brew install git
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="orgheadline4">安装 <a href="http://mercurial.selenic.com/wiki/Download">Mercurial</a></h3>
<div class="outline-text-3" id="text-orgheadline4">
<div class="org-src-container">

<pre class="src src-sh">brew install mercurial
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgheadline5" class="outline-2">
<h2 id="orgheadline5">下载源代码</h2>
<div class="outline-text-2" id="text-orgheadline5">
<p>
设置项目结构并从仓库中获取代码：
</p>
<div class="org-src-container">

<pre class="src src-sh">mkdir $HOME/gocodez
export GOPATH=$HOME/gocodez
mkdir -p $GOPATH/src/github.com/influxdb
cd $GOPATH/src/github.com/influxdb
git clone https://github.com/influxdata/influxdb.git
git checkout v0.10.2
</pre>
</div>
<p>
保持 <code>$GOPATH/src/github.com/influxdb</code> 这样的目录结构是必要，因为这样才能保证 Go import 能够正常工作。
</p>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-2">
<h2 id="orgheadline6">编译和测试</h2>
<div class="outline-text-2" id="text-orgheadline6">
<p>
确保 Go 已经正确安装，然后执行以下命令。可能需要翻墙。
</p>
<div class="org-src-container">

<pre class="src src-sh">cd $GOPATH/src/github.com/influxdb/influxdb
go get -t ./...
</pre>
</div>
<p>
第二条命令会扫描当前目录下的所有 go 源代码，从中找到 import 并从远端下载到本地。在这个过程中可能会碰到编译出错的问题，比如：
</p>
<div class="org-src-container">

<pre class="src src-sh"># github.com/influxdb/influxdb/tsdb/engine/tsm1                                   
tsdb/engine/tsm1/int.go:271: cannot use d.values (type []uint64) as type *[240]uint64 in argument to simple8b.Decode
</pre>
</div>
<p>
类型不一致问题，可能是现在用来编译 influxdb 的第三方库的版本和当时的不一样，因为 go get 命令只会从代码仓库中检出最新的 master，所以我们要检出历史版本。
</p>
<div class="org-src-container">

<pre class="src src-sh">cd $GOPATH/src/github.com/jwilder/encoding/simple8b
git checkout 07d88d4f35eec497617bee0c7bfe651a796dae13
cd $GOPATH/src/github.com/influxdb/influxdb
go get -t ./...
</pre>
</div>
<p>
编译并安装到本地。
</p>
<div class="org-src-container">

<pre class="src src-sh">go clean ./...
go install ./...
</pre>
</div>
<p>
二进制可执行文件将被安装在 <code>$GOPATH/bin</code> 。InfluxDB 的 Server 端的可执行文件的名字为 <code>influxd</code> ， 而 <code>influx</code> 则是 influxdb 的文本界面客户端。可以通过添加编译 flag 来设置编译出来的二进制文件的版本号和 commit 号：
</p>
<div class="org-src-container">

<pre class="src src-sh">-ldflags="-X main.version=$VERSION -X main.branch=$BRANCH -X main.commit=$COMMIT -X main.buildTime=$TIME"
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline7" class="outline-2">
<h2 id="orgheadline7">启动 InfluxDB</h2>
<div class="outline-text-2" id="text-orgheadline7">
<p>
正常情况下，直接运行 influxd 就可以启动 influxdb 了。通过命令生成配置文件，修改后，在启动参数中加入 <code>-config filepath</code> 参数，就可以以指定配置文件启动 influxdb。
</p>
<div class="org-src-container">

<pre class="src src-sh">$GOPATH/bin/influxd config &gt; influxd.conf
vim influxd.conf # 修改配置文件
$GOPATH/bin/influxd -config influxd.conf
</pre>
</div>
</div>
</div>


    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2016-07-09</span>
        <span title="last modification date" class="post-info">2016-07-10</span>
        <span title="tags" class="post-info"><a href="/tags/influxdb/">influxdb</a>, <a href="/tags/go/">go</a></span>
        <span title="author" class="post-info">Shane Xu</span>
      </div>
      <section>
        <h2 class="chapter">Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/2016/07/09/install-legacy-influxdb";
          var disqus_url = "http://xusheng.org/blog/2016/07/09/install-legacy-influxdb";
          var disqus_shortname = 'shanexu';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="//disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </section>
      <script src="//code.jquery.com/jquery-latest.min.js"></script>
      <script src="/media/js/prettify.js"></script>
      <script src="http://xusheng.org/cdn/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>

      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.x (<a href="http://orgmode.org">Org mode</a> 8.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:xusheng0711@gmail.com">Shane Xu</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
