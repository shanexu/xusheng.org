<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>提升 influxdb v0.10.2 性能 - org-page</title>
    <meta charset="utf-8" />
    <meta name="author" content="Shane Xu" />
    <meta name="description" content="how to imporve influxdb v0.10.2 performance" />
    <meta name="keywords" content="influxdb" />
    <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  </head>

  <body class="container">
    <div>
      <header class="masthead">
        <h1 class="masthead-title">
          <a href="/">org-page</a>
        </h1>
        <p>static site generator</p>
        <ul>
          <li><a href="/blog/">Blog</a></li>
          <li><a href="/tags/">Tags</a></li>
          <li><a href="/about/">About</a></li>
          <li><a href="https://github.com/shanexu">GitHub</a></li>
          <li><a href="/rss.xml">RSS</a></li>
        </ul>
        <form method="get" id="searchform" action="//www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="xusheng.org">
        </form>
        <img class="avatar" src="https://avatars.githubusercontent.com/u/1257453?s=400&amp;u=887a49b5ff99794452aa0bc3772fe113cc6e962a&amp;v=4" />
      </header>
    </div>

<div>
<div class="post">
<h1>提升 influxdb v0.10.2 性能</h1>
<p>
之前在给 influxdb 做性能测试的时候，得出的结论，v0.10.2 和 v0.13 在大量写入的时候，会占用大量的内存和 cpu，而之前线上之所以 influxdb 突然拒绝服务，长达数秒之久，原来是它直接挂了。既然 v1.0 还没有发布，我就思考能否将 v1.0 在解决性能问题上的修改，直接 apply 到 v0.10.2 上呢。有了这样一个思路之后，我就开始在 v0.13 的版本和 master 的最新提交之间，不断进行二分查找。最后终于被我找到了那次关键的提交。
</p>

<div class="org-src-container">
<pre class="src src-text">commit c2370b437b9840363ed3d12638fe0ca0ea5ed296
Author: Jason Wilder <a href="mailto:mail%40jasonwilder.com">&lt;mail@jasonwilder.com&gt;</a>
Date:   Fri Jul 15 23:26:25 2016 -0600

    Limit in-flight wal writes/encodings
    
    A slower disk can can cause excessive allocations to occur when
    writing to the WAL because the slower encoding and compression occurs
    before taking the write lock.  The encoding/compression grabs a large
    byte slice from a pool and ultimately waits until it can acquire the
    write lock.
    
    This adds a throttle to limit how many inflight WAL writes can be queued
    up to prevent OOMing the processess with slower disks and heavy writes.
</pre>
</div>

<p>
意思是说限制 wal writes/encodings，在拿到写锁之前，wal 已经 encoding 或者 compression 了，而前面这个操作需要预先，allocation 一块较大的内存，所以很可能造成 OOMing 问题。在看下这次改动的地方。
</p>

<div class="org-src-container">
<pre class="src src-diff"><span class="linenr">  1: </span><span style="color: #0184bc;">diff</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">--git</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">a/pkg/throttle/throttle.go</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">b/pkg/throttle/throttle.go</span>
<span class="linenr">  2: </span><span style="color: #0184bc;">new</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">file</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">mode</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">100644</span>
<span class="linenr">  3: </span><span style="color: #0184bc;">index</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">0000000..f29c4a2</span>
<span class="linenr">  4: </span><span style="color: #0184bc;">---</span><span style="color: #9ca0a4;"> </span><span style="color: #4078f2;">/dev/null</span>
<span class="linenr">  5: </span><span style="color: #0184bc;">+++</span><span style="color: #9ca0a4;"> </span><span style="color: #4078f2;">b/pkg/throttle/throttle.go</span>
<span class="linenr">  6: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-0,0</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+1,18</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span>
<span class="linenr">  7: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">package</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">throttle</span>
<span class="linenr">  8: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span>
<span class="linenr">  9: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">Fixed</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">is</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">a</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">simple</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">channel</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">based</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">concurrency</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">limiter.</span><span style="color: #9ca0a4;">  </span><span style="color: #50a14f; background-color: #f0f0f0;">It</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">uses</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">a</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">fixed</span>
<span class="linenr"> 10: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">size</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">channel</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">to</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">limit</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">callers</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">from</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">proceeding</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">until</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">there</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">is</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">a</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">value</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">avalable</span>
<span class="linenr"> 11: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">in</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">the</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">channel.</span><span style="color: #9ca0a4;">  </span><span style="color: #50a14f; background-color: #f0f0f0;">If</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">all</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">are</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">in-use,</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">the</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">caller</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">blocks</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">until</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">one</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">is</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">freed.</span>
<span class="linenr"> 12: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">type</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">Fixed</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">chan</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">struct{}</span>
<span class="linenr"> 13: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span>
<span class="linenr"> 14: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">New(limit</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">int)</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">Fixed</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">{</span>
<span class="linenr"> 15: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">return</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">make(Fixed,</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">limit)</span>
<span class="linenr"> 16: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">}</span>
<span class="linenr"> 17: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span>
<span class="linenr"> 18: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">(t</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">Fixed)</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">Take()</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">{</span>
<span class="linenr"> 19: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">t</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">&lt;-</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">struct{}{}</span>
<span class="linenr"> 20: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">}</span>
<span class="linenr"> 21: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span>
<span class="linenr"> 22: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">(t</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">Fixed)</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">Release()</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">{</span>
<span class="linenr"> 23: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">&lt;-t</span>
<span class="linenr"> 24: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;">}</span>
<span class="linenr"> 25: </span><span style="color: #0184bc;">diff</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">--git</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">a/tsdb/engine/tsm1/wal.go</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">b/tsdb/engine/tsm1/wal.go</span>
<span class="linenr"> 26: </span><span style="color: #0184bc;">index</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">3926f93..d7880cc</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">100644</span>
<span class="linenr"> 27: </span><span style="color: #0184bc;">---</span><span style="color: #9ca0a4;"> </span><span style="color: #4078f2;">a/tsdb/engine/tsm1/wal.go</span>
<span class="linenr"> 28: </span><span style="color: #0184bc;">+++</span><span style="color: #9ca0a4;"> </span><span style="color: #4078f2;">b/tsdb/engine/tsm1/wal.go</span>
<span class="linenr"> 29: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-18,6</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+18,7</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">import</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">(</span>
<span class="linenr"> 30: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 31: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">"github.com/golang/snappy"</span>
<span class="linenr"> 32: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">"github.com/influxdata/influxdb/models"</span>
<span class="linenr"> 33: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">"github.com/influxdata/influxdb/pkg/throttle"</span>
<span class="linenr"> 34: </span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">)</span>
<span class="linenr"> 35: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 36: </span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">const</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">(</span>
<span class="linenr"> 37: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-90,7</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+91,8</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">type</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">WAL</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">struct</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">{</span>
<span class="linenr"> 38: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">LoggingEnabled</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">bool</span>
<span class="linenr"> 39: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 40: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">statistics</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">for</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">the</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">WAL</span>
<span class="linenr"> 41: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #e45649; background-color: #c6c7c7;">stats</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">*WALStatistics</span>
<span class="linenr"> 42: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">stats</span><span style="color: #9ca0a4;">    </span><span style="color: #50a14f; background-color: #f0f0f0;">*WALStatistics</span>
<span class="linenr"> 43: </span><span style="color: #50a14f; background-color: #f0f0f0;">+</span><span style="color: #50a14f; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">throttle</span><span style="color: #50a14f; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">throttle.Fixed</span>
<span class="linenr"> 44: </span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">}</span>
<span class="linenr"> 45: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 46: </span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">NewWAL(path</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">string)</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">*WAL</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">{</span>
<span class="linenr"> 47: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-103,6</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+105,7</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">NewWAL(path</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">string)</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">*WAL</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">{</span>
<span class="linenr"> 48: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">   </span><span style="color: #4f5158;">logger:</span><span style="color: #9ca0a4;">      </span><span style="color: #4f5158;">log.New(os.Stderr,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">"[tsm1wal]</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">",</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">log.LstdFlags),</span>
<span class="linenr"> 49: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">   </span><span style="color: #4f5158;">closing:</span><span style="color: #9ca0a4;">     </span><span style="color: #4f5158;">make(chan</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">struct{}),</span>
<span class="linenr"> 50: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">   </span><span style="color: #4f5158;">stats:</span><span style="color: #9ca0a4;">       </span><span style="color: #4f5158;">&amp;WALStatistics{},</span>
<span class="linenr"> 51: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;">   </span><span style="color: #50a14f; background-color: #f0f0f0;">throttle:</span><span style="color: #9ca0a4;">    </span><span style="color: #50a14f; background-color: #f0f0f0;">throttle.New(10),</span>
<span class="linenr"> 52: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">}</span>
<span class="linenr"> 53: </span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">}</span>
<span class="linenr"> 54: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 55: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-277,6</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+280,12</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">(l</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">*WAL)</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">LastWriteTime()</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">time.Time</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">{</span>
<span class="linenr"> 56: </span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">}</span>
<span class="linenr"> 57: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 58: </span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">(l</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">*WAL)</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">writeToLog(entry</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">WALEntry)</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">(int,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">error)</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">{</span>
<span class="linenr"> 59: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">limit</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">how</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">many</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">concurrent</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">encodings</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">can</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">be</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">in</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">flight.</span><span style="color: #9ca0a4;">  </span><span style="color: #50a14f; background-color: #f0f0f0;">Since</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">we</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">can</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">only</span>
<span class="linenr"> 60: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">write</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">one</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">at</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">a</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">time</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">to</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">disk,</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">a</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">slow</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">disk</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">can</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">cause</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">the</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">allocations</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">below</span>
<span class="linenr"> 61: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">to</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">increase</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">quickly.</span><span style="color: #9ca0a4;">  </span><span style="color: #50a14f; background-color: #f0f0f0;">If</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">we're</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">backed</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">up,</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">wait</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">until</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">others</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">have</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">completed.</span>
<span class="linenr"> 62: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">l.throttle.Take()</span>
<span class="linenr"> 63: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">defer</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">l.throttle.Release()</span>
<span class="linenr"> 64: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span>
<span class="linenr"> 65: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">encode</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">and</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">compress</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">the</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">entry</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">while</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">we're</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">not</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">locked</span>
<span class="linenr"> 66: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">bytes</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">:=</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">getBuf(walEncodeBufSize)</span>
<span class="linenr"> 67: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">defer</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">putBuf(bytes)</span>
<span class="linenr"> 68: </span><span style="color: #0184bc;">diff</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">--git</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">a/tsdb/store.go</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">b/tsdb/store.go</span>
<span class="linenr"> 69: </span><span style="color: #0184bc;">index</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">5889577..3076d01</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">100644</span>
<span class="linenr"> 70: </span><span style="color: #0184bc;">---</span><span style="color: #9ca0a4;"> </span><span style="color: #4078f2;">a/tsdb/store.go</span>
<span class="linenr"> 71: </span><span style="color: #0184bc;">+++</span><span style="color: #9ca0a4;"> </span><span style="color: #4078f2;">b/tsdb/store.go</span>
<span class="linenr"> 72: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-16,6</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+16,7</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">import</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">(</span>
<span class="linenr"> 73: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 74: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">"github.com/influxdata/influxdb/influxql"</span>
<span class="linenr"> 75: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">"github.com/influxdata/influxdb/models"</span>
<span class="linenr"> 76: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">"github.com/influxdata/influxdb/pkg/throttle"</span>
<span class="linenr"> 77: </span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">)</span>
<span class="linenr"> 78: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 79: </span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">var</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">(</span>
<span class="linenr"> 80: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-145,7</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+146,7</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">(s</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">*Store)</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">loadShards()</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">error</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">{</span>
<span class="linenr"> 81: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">   </span><span style="color: #4f5158;">err</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">error</span>
<span class="linenr"> 82: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">}</span>
<span class="linenr"> 83: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 84: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #e45649; background-color: #c6c7c7;">throttle</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">:=</span><span style="color: #e45649; background-color: #c6c7c7;"> </span><span style="color: #e45649; background-color: #c6c7c7;">newthrottle</span><span style="color: #e45649; background-color: #c6c7c7;">(runtime.GOMAXPROCS(0))</span>
<span class="linenr"> 85: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">t</span><span style="color: #50a14f; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">:=</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">throttle</span><span style="color: #50a14f; background-color: #f0f0f0;">.New</span><span style="color: #50a14f; background-color: #f0f0f0;">(runtime.GOMAXPROCS(0))</span>
<span class="linenr"> 86: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 87: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">resC</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">:=</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">make(chan</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">*res)</span>
<span class="linenr"> 88: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">var</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">n</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">int</span>
<span class="linenr"> 89: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-171,8</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+172,8</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">(s</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">*Store)</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">loadShards()</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">error</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">{</span>
<span class="linenr"> 90: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">     </span><span style="color: #4f5158;">for</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">_,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">sh</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">:=</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">range</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">shards</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">{</span>
<span class="linenr"> 91: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">       </span><span style="color: #4f5158;">n++</span>
<span class="linenr"> 92: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">       </span><span style="color: #4f5158;">go</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">func(index</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">*DatabaseIndex,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">db,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">rp,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">sh</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">string)</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">{</span>
<span class="linenr"> 93: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #9ca0a4; background-color: #f0f0f0;">         </span><span style="color: #e45649; background-color: #c6c7c7;">throttle</span><span style="color: #e45649; background-color: #c6c7c7;">.</span><span style="color: #e45649; background-color: #c6c7c7;">take</span><span style="color: #e45649; background-color: #c6c7c7;">()</span>
<span class="linenr"> 94: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #9ca0a4; background-color: #f0f0f0;">         </span><span style="color: #e45649; background-color: #c6c7c7;">defer</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">throttle</span><span style="color: #e45649; background-color: #c6c7c7;">.</span><span style="color: #e45649; background-color: #c6c7c7;">release</span><span style="color: #e45649; background-color: #c6c7c7;">()</span>
<span class="linenr"> 95: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;">         </span><span style="color: #50a14f; background-color: #f0f0f0;">t</span><span style="color: #50a14f; background-color: #f0f0f0;">.</span><span style="color: #50a14f; background-color: #f0f0f0;">Take</span><span style="color: #50a14f; background-color: #f0f0f0;">()</span>
<span class="linenr"> 96: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;">         </span><span style="color: #50a14f; background-color: #f0f0f0;">defer</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">t</span><span style="color: #50a14f; background-color: #f0f0f0;">.</span><span style="color: #50a14f; background-color: #f0f0f0;">Release</span><span style="color: #50a14f; background-color: #f0f0f0;">()</span>
<span class="linenr"> 97: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr"> 98: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">         </span><span style="color: #4f5158;">start</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">:=</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">time.Now()</span>
<span class="linenr"> 99: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">         </span><span style="color: #4f5158;">path</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">:=</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">filepath.Join(s.path,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">db,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">rp,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">sh)</span>
<span class="linenr">100: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-514,7</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+515,7</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">(s</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">*Store)</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">walkShards(shards</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">[]*Shard,</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">fn</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">func(sh</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">*Shard)</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">error)</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">error</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">{</span>
<span class="linenr">101: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">   </span><span style="color: #4f5158;">err</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">error</span>
<span class="linenr">102: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">}</span>
<span class="linenr">103: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr">104: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #e45649; background-color: #c6c7c7;">throttle</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">:=</span><span style="color: #e45649; background-color: #c6c7c7;"> </span><span style="color: #e45649; background-color: #c6c7c7;">newthrottle</span><span style="color: #e45649; background-color: #c6c7c7;">(runtime.GOMAXPROCS(0))</span>
<span class="linenr">105: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">t</span><span style="color: #50a14f; background-color: #f0f0f0;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">:=</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">throttle</span><span style="color: #50a14f; background-color: #f0f0f0;">.New</span><span style="color: #50a14f; background-color: #f0f0f0;">(runtime.GOMAXPROCS(0))</span>
<span class="linenr">106: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr">107: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">resC</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">:=</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">make(chan</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">res)</span>
<span class="linenr">108: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">var</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">n</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">int</span>
<span class="linenr">109: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-523,8</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+524,8</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">(s</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">*Store)</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">walkShards(shards</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">[]*Shard,</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">fn</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">func(sh</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">*Shard)</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">error)</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">error</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">{</span>
<span class="linenr">110: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">   </span><span style="color: #4f5158;">n++</span>
<span class="linenr">111: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr">112: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">   </span><span style="color: #4f5158;">go</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">func(sh</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">*Shard)</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">{</span>
<span class="linenr">113: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #9ca0a4; background-color: #f0f0f0;">     </span><span style="color: #e45649; background-color: #c6c7c7;">throttle</span><span style="color: #e45649; background-color: #c6c7c7;">.</span><span style="color: #e45649; background-color: #c6c7c7;">take</span><span style="color: #e45649; background-color: #c6c7c7;">()</span>
<span class="linenr">114: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #9ca0a4; background-color: #f0f0f0;">     </span><span style="color: #e45649; background-color: #c6c7c7;">defer</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">throttle</span><span style="color: #e45649; background-color: #c6c7c7;">.</span><span style="color: #e45649; background-color: #c6c7c7;">release</span><span style="color: #e45649; background-color: #c6c7c7;">()</span>
<span class="linenr">115: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;">     </span><span style="color: #50a14f; background-color: #f0f0f0;">t</span><span style="color: #50a14f; background-color: #f0f0f0;">.</span><span style="color: #50a14f; background-color: #f0f0f0;">Take</span><span style="color: #50a14f; background-color: #f0f0f0;">()</span>
<span class="linenr">116: </span><span style="color: #22aa22; background-color: #f0f0f0;">+</span><span style="color: #9ca0a4; background-color: #f0f0f0;">     </span><span style="color: #50a14f; background-color: #f0f0f0;">defer</span><span style="color: #9ca0a4;"> </span><span style="color: #50a14f; background-color: #f0f0f0;">t</span><span style="color: #50a14f; background-color: #f0f0f0;">.</span><span style="color: #50a14f; background-color: #f0f0f0;">Release</span><span style="color: #50a14f; background-color: #f0f0f0;">()</span>
<span class="linenr">117: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr">118: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">     </span><span style="color: #4f5158;">if</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">err</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">:=</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">fn(sh);</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">err</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">!=</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">nil</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">{</span>
<span class="linenr">119: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;">       </span><span style="color: #4f5158;">resC</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">&lt;-</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">res{err:</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">fmt.Errorf("shard</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">%d:</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">%s",</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">sh.id,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">err)}</span>
<span class="linenr">120: </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">-914,20</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">+915,3</span><span style="color: #9ca0a4;"> </span><span style="color: #b751b6;">@@</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">measurementsFromSourcesOrDB(db</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">*DatabaseIndex,</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">sources</span><span style="color: #9ca0a4;"> </span><span style="color: #0184bc;">...influxql.Source)</span>
<span class="linenr">121: </span><span style="color: #9ca0a4;"> </span>
<span class="linenr">122: </span><span style="color: #9ca0a4;"> </span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #4f5158;">return</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">measurements,</span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">nil</span>
<span class="linenr">123: </span><span style="color: #9ca0a4;"> </span><span style="color: #4f5158;">}</span>
<span class="linenr">124: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span>
<span class="linenr">125: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #e45649; background-color: #c6c7c7;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">throttle</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">is</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">a</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">simple</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">channel</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">based</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">concurrency</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">limiter.</span><span style="color: #9ca0a4;">  </span><span style="color: #e45649; background-color: #c6c7c7;">It</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">uses</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">a</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">fixed</span>
<span class="linenr">126: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #e45649; background-color: #c6c7c7;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">size</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">channel</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">to</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">limit</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">callers</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">from</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">proceeding</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">until</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">there</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">is</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">a</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">value</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">avalable</span>
<span class="linenr">127: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #e45649; background-color: #c6c7c7;">//</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">in</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">the</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">channel.</span><span style="color: #9ca0a4;">  </span><span style="color: #e45649; background-color: #c6c7c7;">If</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">all</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">are</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">in-use,</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">the</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">caller</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">blocks</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">until</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">one</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">is</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">freed.</span>
<span class="linenr">128: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #e45649; background-color: #c6c7c7;">type</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">throttle</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">chan</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">struct{}</span>
<span class="linenr">129: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span>
<span class="linenr">130: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #e45649; background-color: #c6c7c7;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">newthrottle(limit</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">int)</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">throttle</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">{</span>
<span class="linenr">131: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #e45649; background-color: #c6c7c7;">return</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">make(throttle,</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">limit)</span>
<span class="linenr">132: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #e45649; background-color: #c6c7c7;">}</span>
<span class="linenr">133: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span>
<span class="linenr">134: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #e45649; background-color: #c6c7c7;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">(t</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">throttle)</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">take()</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">{</span>
<span class="linenr">135: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #e45649; background-color: #c6c7c7;">t</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">&lt;-</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">struct{}{}</span>
<span class="linenr">136: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #e45649; background-color: #c6c7c7;">}</span>
<span class="linenr">137: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span>
<span class="linenr">138: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #e45649; background-color: #c6c7c7;">func</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">(t</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">throttle)</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">release()</span><span style="color: #9ca0a4;"> </span><span style="color: #e45649; background-color: #c6c7c7;">{</span>
<span class="linenr">139: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #9ca0a4; background-color: #f0f0f0;"> </span><span style="color: #e45649; background-color: #c6c7c7;">&lt;-t</span>
<span class="linenr">140: </span><span style="color: #aa2222; background-color: #c6c7c7;">-</span><span style="color: #e45649; background-color: #c6c7c7;">}</span>
<span class="linenr">141: </span>
</pre>
</div>

<p>
以 encoding wal 为例，这里增加了一个 <code>throttle.take()</code> 动作，并且在完成操作后，执行 <code>throttle.release()</code> 方法， <code>throttle</code> 里面放了固定数量的值，当调用 take 方法的时候如果 <code>throttle</code> 中如果没有资源，那么调用者就会 <code>block</code> ，直到  <code>throttle</code> 中有了新的资源，也就是其他调用者完成自己动作，并调用 <code>release</code> 方法。
</p>

<p>
然后将这部分的改动，合并到 v0.10.2 的代码中，并进行测试。结果入下。
</p>

<div class="org-src-container">
<pre class="src src-text">Requests      [total, rate]            1500000, 5000.00
Duration      [total, attack, wait]    5m0.000129097s, 4m59.999799858s, 329.239&#181;s
Latencies     [mean, 50, 95, 99, max]  1.227473ms, 230.474&#181;s, 1.237975ms, 33.100274ms, 251.524774ms
Bytes In      [total, mean]            0, 0.00
Bytes Out     [total, mean]            59994600, 40.00
Success       [ratio]                  99.99%
Status Codes  [code:count]             204:1499865  0:135

Requests      [total, rate]            1500000, 5000.00
Duration      [total, attack, wait]    5m0.000380718s, 4m59.999799905s, 580.813&#181;s
Latencies     [mean, 50, 95, 99, max]  1.477462ms, 239.262&#181;s, 2.878066ms, 36.939105ms, 328.367048ms
Bytes In      [total, mean]            0, 0.00
Bytes Out     [total, mean]            60000000, 40.00
Success       [ratio]                  100.00%
Status Codes  [code:count]             204:1500000

Requests      [total, rate]            1500000, 5000.00
Duration      [total, attack, wait]    5m0.000769812s, 4m59.999799915s, 969.897&#181;s
Latencies     [mean, 50, 95, 99, max]  1.957877ms, 242.364&#181;s, 3.483565ms, 41.994757ms, 638.448146ms
Bytes In      [total, mean]            0, 0.00
Bytes Out     [total, mean]            59999880, 40.00
Success       [ratio]                  100.00%
Status Codes  [code:count]             204:1499997  0:3
</pre>
</div>

<p>
这已经是跟 v1.0 版本的结果差不多了。
</p>

</div>
</div>
    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2016-07-30</span>
        <span title="last modification date" class="post-info">2016-07-31</span>
        <span title="tags" class="post-info"><a href="/tags/influxdb/">influxdb</a>, <a href="/tags/go/">go</a></span>
        <span title="author" class="post-info">Shane Xu</span>
      </div>
      <section>
        <h1>Comments</h1>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/2016/07/30/imporve-influxdb-v0.10.2-performance";
          var disqus_url = "https://xusheng.org/blog/2016/07/30/imporve-influxdb-v0.10.2-performance";
          var disqus_shortname = 'shanexu';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="//disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
       <div id="hashover"></div>
       <script type="text/javascript" src="/hashover.php"></script>
       <noscript>You must have JavaScript enabled to use the comments.</noscript>
      </section>
      <script src="//code.jquery.com/jquery-latest.min.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="/media/js/main.js"></script>
      <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-74684473-1']);
        _gaq.push(['_trackPageview']);
        (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 29.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:xusheng0711 &lt;at&gt; gmail &lt;dot&gt; com">Shane Xu</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
