<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Binding.scala in Practice - Shane Xu&#39;s Home</title>
    <meta charset="utf-8" />
    <meta name="author" content="Shane Xu" />
    <meta name="description" content="&lt;TODO: insert your description here&gt;" />
    <meta name="keywords" content="scala.js, Binding.scala, scala" />
    <link rel="stylesheet" href="/media/source-code-pro/source-code-pro.css" type="text/css">
    <link rel="stylesheet" href="/media/css/org-manual.css" type="text/css">
    <link rel="stylesheet" href="/media/css/extra.css" type="text/css">
    <link rel="stylesheet" href="/media/css/code-dark.css" type="text/css">
    <!-- <link rel="stylesheet" href="/media/css/code-light.css" type="text/css"> -->
  </head>

  <body>
    <div>
      <header class="masthead">
        <h1 class="settitle"><a href="/">Shane Xu&#39;s Home</a></h1>
        <blockquote>Life is too short for so much sorrow.</blockquote>
        <form method="get" id="searchform" action="//www.google.com/search">
          <input type="text" class="field" name="q" id="s" placeholder="Search">
          <input type="hidden" name="as_sitesearch" value="xusheng.org">
        </form>
      </header>
    </div>
    <div class="node nav">
      <ul>
          <li><a href="/blog/">Blog</a></li>
        <li><a href="/tags/">Tags</a></li>
        <li><a href="/about/">About</a></li>
        <li><a href="https://github.com/shanexu">GitHub</a></li>
        <li><a href="/rss.xml">RSS</a></li>
      </ul>
      <hr/>
    </div>


  <h3 class="section">Binding.scala in Practice</h3>
<p>
开了这个题目之后，我久久不知道如何动笔。搁置了一周之后，我终于下定决心写好这篇文章。我就来写写，我这两星期 <code>我</code> 和 <a href="https://www.scala-js.org/">scala.js</a> 以及 <a href="https://github.com/ThoughtWorksInc/Binding.scala">Binding.scala</a> 浴血奋战的故事(<a href="http://music.163.com/#/song?id=22790726">You and Music and Dream</a>)。
</p>

<p>
首先，创建一个最简单的 scala.js with Binding.scala 的项目。
</p>

<div class="org-src-container">
<pre class="src src-shell">mkdir simple-scala.js-Binding.scala
<span style="color: #56B6C2;">cd</span> simple-scala.js-Binding.scala
mkdir -p js/src/<span style="color: #ABB2BF;">{</span>main,test<span style="color: #ABB2BF;">}</span>/scala
mkdir project
<span style="color: #56B6C2;">echo</span> sbt.version=<span style="color: #56B6C2;">0.13.13</span> &gt; project/build.properties
<span style="color: #56B6C2;">echo</span> <span style="color: #98C379;">'resolvers += "Typesafe Releases" at "http://repo.typesafe.com/typesafe/releases/"</span>

<span style="color: #98C379;">addSbtPlugin("org.scala-js" % "sbt-scalajs" % "0.6.14")</span>

<span style="color: #98C379;">addSbtPlugin("com.eed3si9n" % "sbt-assembly" % "0.14.3")</span>
<span style="color: #98C379;">'</span> &gt; project/plugin.sbt
touch build.sbt
</pre>
</div>

<p>
然后在 <code>build.sbt</code> 中添加如下内容。
</p>

<div class="org-src-container">
<pre class="src src-scala"><span class="linenr"> 1: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">commonSettings</span> <span style="color: #C678DD;">=</span> <span style="color: #56B6C2;">Seq</span><span style="color: #ABB2BF;">(</span>
<span class="linenr"> 2: </span>  version := <span style="color: #98C379;">"0.0.1"</span>,
<span class="linenr"> 3: </span>  scalaVersion := <span style="color: #98C379;">"2.11.8"</span>,
<span class="linenr"> 4: </span>  addCompilerPlugin<span style="color: #C678DD;">(</span><span style="color: #98C379;">"org.scalamacros"</span> % <span style="color: #98C379;">"paradise"</span> % <span style="color: #98C379;">"2.1.0"</span> cross <span style="color: #56B6C2;">CrossVersion</span>.full<span style="color: #C678DD;">)</span>,
<span class="linenr"> 5: </span>  scalacOptions ++= <span style="color: #56B6C2;">Seq</span><span style="color: #C678DD;">(</span><span style="color: #98C379;">"-feature"</span>, <span style="color: #98C379;">"-language:implicitConversions"</span><span style="color: #C678DD;">)</span>
<span class="linenr"> 6: </span><span style="color: #ABB2BF;">)</span>
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">BindingScalaVersion</span> <span style="color: #C678DD;">=</span> <span style="color: #98C379;">"10.0.1"</span>
<span class="linenr"> 9: </span>
<span class="linenr">10: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">root</span> <span style="color: #C678DD;">=</span> <span style="color: #ABB2BF;">(</span>project in file<span style="color: #C678DD;">(</span><span style="color: #98C379;">"."</span><span style="color: #C678DD;">)</span><span style="color: #ABB2BF;">)</span>.
<span class="linenr">11: </span>  settings<span style="color: #ABB2BF;">(</span>commonSettings<span style="color: #C678DD;">:</span> <span style="color: #C678DD;">_</span>*<span style="color: #ABB2BF;">)</span>.
<span class="linenr">12: </span>  aggregate<span style="color: #ABB2BF;">(</span>js<span style="color: #ABB2BF;">)</span>
<span class="linenr">13: </span>
<span class="linenr">14: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">js</span> <span style="color: #C678DD;">=</span> <span style="color: #ABB2BF;">(</span>project in file<span style="color: #C678DD;">(</span><span style="color: #98C379;">"js"</span><span style="color: #C678DD;">)</span><span style="color: #ABB2BF;">)</span>.
<span class="linenr">15: </span>  settings<span style="color: #ABB2BF;">(</span>commonSettings<span style="color: #C678DD;">:</span> <span style="color: #C678DD;">_</span>*<span style="color: #ABB2BF;">)</span>.
<span class="linenr">16: </span>  settings<span style="color: #ABB2BF;">(</span>
<span class="linenr">17: </span>    mainClass in <span style="color: #C678DD;">(</span><span style="color: #56B6C2;">Compile</span><span style="color: #C678DD;">)</span> := <span style="color: #56B6C2;">Some</span><span style="color: #C678DD;">(</span><span style="color: #98C379;">"Application"</span><span style="color: #C678DD;">)</span>,
<span class="linenr">18: </span>    persistLauncher := <span style="color: #56B6C2;">true</span>,
<span class="linenr">19: </span>    libraryDependencies ++= <span style="color: #56B6C2;">Seq</span><span style="color: #C678DD;">(</span>
<span class="linenr">20: </span>      <span style="color: #98C379;">"org.scala-js"</span> %%% <span style="color: #98C379;">"scalajs-dom"</span> % <span style="color: #98C379;">"0.9.1"</span>,
<span class="linenr">21: </span>      <span style="color: #98C379;">"com.thoughtworks.binding"</span> %%% <span style="color: #98C379;">"dom"</span> % <span style="color: #56B6C2;">BindingScalaVersion</span>,
<span class="linenr">22: </span>      <span style="color: #98C379;">"com.thoughtworks.binding"</span> %%% <span style="color: #98C379;">"route"</span> % <span style="color: #56B6C2;">BindingScalaVersion</span>
<span class="linenr">23: </span>    <span style="color: #C678DD;">)</span>
<span class="linenr">24: </span>  <span style="color: #ABB2BF;">)</span>.
<span class="linenr">25: </span>  enablePlugins<span style="color: #ABB2BF;">(</span><span style="color: #56B6C2;">ScalaJSPlugin</span><span style="color: #ABB2BF;">)</span>
</pre>
</div>

<p>
然后写一个 <code>Main</code> 函数。
</p>

<div class="org-src-container">
<pre class="src src-scala"><span class="linenr">1: </span><span style="color: #5C6370;">/* </span><span style="color: #5C6370;">js/src/main/scala/Application.scala */</span>
<span class="linenr">2: </span><span style="color: #C678DD;">import</span> scala.scalajs.js.<span style="color: #56B6C2;">JSApp</span>
<span class="linenr">3: </span>
<span class="linenr">4: </span><span style="color: #C678DD;">object</span> <span style="color: #56B6C2;">Application</span> <span style="color: #C678DD;">extends</span> <span style="color: #E5C07B;">JSApp</span> <span style="color: #ABB2BF;">{</span>
<span class="linenr">5: </span>  <span style="color: #C678DD;">def</span> <span style="color: #61AFEF;">main</span><span style="color: #C678DD;">()</span><span style="color: #C678DD;">:</span> <span style="color: #E5C07B;">Unit</span> <span style="color: #C678DD;">=</span> println<span style="color: #C678DD;">(</span><span style="color: #98C379;">"Hello World!"</span><span style="color: #C678DD;">)</span>
<span class="linenr">6: </span><span style="color: #ABB2BF;">}</span>
</pre>
</div>

<p>
至此一个最简单的 <code>scala.js</code> with <code>Binding.scala</code> 的工程已经搭建好了。
</p>

<p>
执行 <code>sbt fastOptJS</code>
</p>
<div class="org-src-container">
<pre class="src src-shell">$ ls js/target/scala-2.11
classes           js-fastopt.js     js-fastopt.js.map js-jsdeps.js      js-launcher.js
</pre>
</div>

<p>
在项目根目录下新建一个 <code>index.html</code> 
</p>
<div class="org-src-container">
<pre class="src src-html"><span class="linenr"> 1: </span>&lt;<span style="color: #C678DD;">!doctype</span> html&gt;
<span class="linenr"> 2: </span>&lt;<span style="color: #61AFEF;">html</span>&gt;
<span class="linenr"> 3: </span>  &lt;<span style="color: #61AFEF;">head</span>&gt;
<span class="linenr"> 4: </span>    &lt;<span style="color: #61AFEF;">meta</span> <span style="color: #E06C75;">charset</span>=<span style="color: #98C379;">"utf-8"</span>&gt;
<span class="linenr"> 5: </span>    &lt;<span style="color: #61AFEF;">meta</span> <span style="color: #E06C75;">http-equiv</span>=<span style="color: #98C379;">"X-UA-Compatible"</span> <span style="color: #E06C75;">content</span>=<span style="color: #98C379;">"IE=edge,chrome=1"</span>&gt;
<span class="linenr"> 6: </span>    &lt;<span style="color: #61AFEF;">meta</span> <span style="color: #E06C75;">name</span>=<span style="color: #98C379;">"description"</span> <span style="color: #E06C75;">content</span>=<span style="color: #98C379;">""</span>&gt;
<span class="linenr"> 7: </span>    &lt;<span style="color: #61AFEF;">meta</span> <span style="color: #E06C75;">name</span>=<span style="color: #98C379;">"viewport"</span> <span style="color: #E06C75;">content</span>=<span style="color: #98C379;">"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"</span>&gt;
<span class="linenr"> 8: </span>    &lt;<span style="color: #61AFEF;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Hello World!</span>&lt;/<span style="color: #61AFEF;">title</span>&gt;
<span class="linenr"> 9: </span>    &lt;<span style="color: #61AFEF;">script</span> <span style="color: #E06C75;">type</span>=<span style="color: #98C379;">"text/javascript"</span> <span style="color: #E06C75;">src</span>=<span style="color: #98C379;">"./js/target/scala-2.11/js-jsdeps.js"</span>&gt;&lt;/<span style="color: #61AFEF;">script</span>&gt;
<span class="linenr">10: </span>    &lt;<span style="color: #61AFEF;">script</span> <span style="color: #E06C75;">type</span>=<span style="color: #98C379;">"text/javascript"</span> <span style="color: #E06C75;">src</span>=<span style="color: #98C379;">"./js/target/scala-2.11/js-fastopt.js"</span>&gt;&lt;/<span style="color: #61AFEF;">script</span>&gt;
<span class="linenr">11: </span>  &lt;/<span style="color: #61AFEF;">head</span>&gt;
<span class="linenr">12: </span>  &lt;<span style="color: #61AFEF;">body</span>&gt;
<span class="linenr">13: </span>    &lt;<span style="color: #61AFEF;">script</span> <span style="color: #E06C75;">type</span>=<span style="color: #98C379;">"text/javascript"</span> <span style="color: #E06C75;">src</span>=<span style="color: #98C379;">"./js/target/scala-2.11/js-launcher.js"</span>&gt;&lt;/<span style="color: #61AFEF;">script</span>&gt;
<span class="linenr">14: </span>  &lt;/<span style="color: #61AFEF;">body</span>&gt;
<span class="linenr">15: </span>&lt;/<span style="color: #61AFEF;">html</span>&gt;
</pre>
</div>

<p>
在浏览器中打开，就能看到我们亲切的 <code>Hello World!</code> 了。
</p>

<iframe height="300" frameborder="0" style="width: 100%; overflow: hidden;" src="https://embed.scalafiddle.io/embed?sfid=zKNO24v/0"></iframe>

<p>
然而一个真正的前端项目，不可能一直使用本地文件来验证查看的，所以我需要一个server。=Play= 和 <code>scalatra</code> 在这个场景中有点杀鸡用牛刀的感觉，所以我选择了 <code>Akka Http</code> 做这个 <code>webserver</code> 。
中间又出了点变故，本来打算用 <code>nginx</code> 伺服所有的静态文件的，后来深感线上虚拟机上搞一个nginx，还要搞个发布流程甚是麻烦。索性打成一个可以执行的jar，来的方便，一股脑地就把配置写好吧。
</p>

<div class="org-src-container">
<pre class="src src-scala"><span class="linenr"> 1: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">commonSettings</span> <span style="color: #C678DD;">=</span> <span style="color: #56B6C2;">Seq</span><span style="color: #ABB2BF;">(</span>
<span class="linenr"> 2: </span>  version := <span style="color: #98C379;">"0.0.1"</span>,
<span class="linenr"> 3: </span>  scalaVersion := <span style="color: #98C379;">"2.11.8"</span>,
<span class="linenr"> 4: </span>  addCompilerPlugin<span style="color: #C678DD;">(</span><span style="color: #98C379;">"org.scalamacros"</span> % <span style="color: #98C379;">"paradise"</span> % <span style="color: #98C379;">"2.1.0"</span> cross <span style="color: #56B6C2;">CrossVersion</span>.full<span style="color: #C678DD;">)</span>,
<span class="linenr"> 5: </span>  scalacOptions ++= <span style="color: #56B6C2;">Seq</span><span style="color: #C678DD;">(</span><span style="color: #98C379;">"-feature"</span>, <span style="color: #98C379;">"-language:implicitConversions"</span><span style="color: #C678DD;">)</span>
<span class="linenr"> 6: </span><span style="color: #ABB2BF;">)</span>
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">AkkaVersion</span> <span style="color: #C678DD;">=</span> <span style="color: #98C379;">"2.4.16"</span>
<span class="linenr"> 9: </span>
<span class="linenr">10: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">AkkaHttpVersion</span> <span style="color: #C678DD;">=</span> <span style="color: #98C379;">"10.0.1"</span>
<span class="linenr">11: </span>
<span class="linenr">12: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">BindingScalaVersion</span> <span style="color: #C678DD;">=</span> <span style="color: #98C379;">"10.0.1"</span>
<span class="linenr">13: </span>
<span class="linenr">14: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">CirceVersion</span> <span style="color: #C678DD;">=</span> <span style="color: #98C379;">"0.6.1"</span>
<span class="linenr">15: </span>
<span class="linenr">16: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">ScalazVersion</span> <span style="color: #C678DD;">=</span> <span style="color: #98C379;">"7.2.8"</span>
<span class="linenr">17: </span>
<span class="linenr">18: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">compileCopyTask</span> <span style="color: #C678DD;">=</span> taskKey<span style="color: #ABB2BF;">[</span><span style="color: #56B6C2;">Unit</span><span style="color: #ABB2BF;">](</span><span style="color: #98C379;">"compile and copy"</span><span style="color: #ABB2BF;">)</span>
<span class="linenr">19: </span>
<span class="linenr">20: </span>
<span class="linenr">21: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">root</span> <span style="color: #C678DD;">=</span> <span style="color: #ABB2BF;">(</span>project in file<span style="color: #C678DD;">(</span><span style="color: #98C379;">"."</span><span style="color: #C678DD;">)</span><span style="color: #ABB2BF;">)</span>.
<span class="linenr">22: </span>  settings<span style="color: #ABB2BF;">(</span>commonSettings<span style="color: #C678DD;">:</span> <span style="color: #C678DD;">_</span>*<span style="color: #ABB2BF;">)</span>.
<span class="linenr">23: </span>  aggregate<span style="color: #ABB2BF;">(</span>server, js<span style="color: #ABB2BF;">)</span>
<span class="linenr">24: </span>
<span class="linenr">25: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">server</span> <span style="color: #C678DD;">=</span> <span style="color: #ABB2BF;">(</span>project in file<span style="color: #C678DD;">(</span><span style="color: #98C379;">"server"</span><span style="color: #C678DD;">)</span><span style="color: #ABB2BF;">)</span>.
<span class="linenr">26: </span>  settings<span style="color: #ABB2BF;">(</span>commonSettings<span style="color: #C678DD;">:</span> <span style="color: #C678DD;">_</span>*<span style="color: #ABB2BF;">)</span>.
<span class="linenr">27: </span>  settings<span style="color: #ABB2BF;">(</span>
<span class="linenr">28: </span>    cancelable in <span style="color: #56B6C2;">Global</span> := <span style="color: #56B6C2;">true</span>,
<span class="linenr">29: </span>    fork in run := <span style="color: #56B6C2;">true</span>,
<span class="linenr">30: </span>    libraryDependencies ++= <span style="color: #56B6C2;">Seq</span><span style="color: #C678DD;">(</span>
<span class="linenr">31: </span>      <span style="color: #98C379;">"com.typesafe.akka"</span> %% <span style="color: #98C379;">"akka-actor"</span> % <span style="color: #56B6C2;">AkkaVersion</span>,
<span class="linenr">32: </span>      <span style="color: #98C379;">"com.typesafe.akka"</span> %% <span style="color: #98C379;">"akka-stream"</span> % <span style="color: #56B6C2;">AkkaVersion</span>,
<span class="linenr">33: </span>      <span style="color: #98C379;">"com.typesafe.akka"</span> %% <span style="color: #98C379;">"akka-http"</span> % <span style="color: #56B6C2;">AkkaHttpVersion</span>,
<span class="linenr">34: </span>      <span style="color: #98C379;">"ch.qos.logback"</span> %  <span style="color: #98C379;">"logback-classic"</span> % <span style="color: #98C379;">"1.1.7"</span>,
<span class="linenr">35: </span>      <span style="color: #98C379;">"com.typesafe.scala-logging"</span> %% <span style="color: #98C379;">"scala-logging"</span> % <span style="color: #98C379;">"3.5.0"</span>
<span class="linenr">36: </span>    <span style="color: #C678DD;">)</span>
<span class="linenr">37: </span>  <span style="color: #ABB2BF;">)</span>.
<span class="linenr">38: </span>  settings<span style="color: #ABB2BF;">(</span>
<span class="linenr">39: </span>    compileCopyTask := <span style="color: #C678DD;">{</span>
<span class="linenr">40: </span>      <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">mainVersion</span> <span style="color: #C678DD;">=</span> scalaVersion.value.split<span style="color: #61AFEF;">(</span><span style="color: #98C379;">"""\."""</span><span style="color: #61AFEF;">)</span>.take<span style="color: #61AFEF;">(</span><span style="color: #56B6C2;">2</span><span style="color: #61AFEF;">)</span>.mkString<span style="color: #61AFEF;">(</span><span style="color: #98C379;">"."</span><span style="color: #61AFEF;">)</span>
<span class="linenr">41: </span>      <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">to</span> <span style="color: #C678DD;">=</span> target.value / <span style="color: #61AFEF;">(</span><span style="color: #98C379;">"scala-"</span> + mainVersion<span style="color: #61AFEF;">)</span> / <span style="color: #98C379;">"classes"</span> / <span style="color: #98C379;">"static"</span> / <span style="color: #98C379;">"js"</span>
<span class="linenr">42: </span>      to.mkdirs<span style="color: #61AFEF;">()</span>
<span class="linenr">43: </span>      <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">fastJs</span> <span style="color: #C678DD;">=</span> <span style="color: #61AFEF;">(</span>fastOptJS in <span style="color: #56B6C2;">Compile</span> in js<span style="color: #61AFEF;">)</span>.value.data
<span class="linenr">44: </span>      <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">fastJsSourceMap</span> <span style="color: #C678DD;">=</span> fastJs.getParentFile / <span style="color: #61AFEF;">(</span>fastJs.getName + <span style="color: #98C379;">".map"</span><span style="color: #61AFEF;">)</span>
<span class="linenr">45: </span>      <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">fastJsLauncher</span> <span style="color: #C678DD;">=</span> <span style="color: #61AFEF;">(</span>packageScalaJSLauncher in <span style="color: #56B6C2;">Compile</span> in js<span style="color: #61AFEF;">)</span>.value.data
<span class="linenr">46: </span>      <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">fastJsDeps</span> <span style="color: #C678DD;">=</span> <span style="color: #61AFEF;">(</span>packageJSDependencies in <span style="color: #56B6C2;">Compile</span> in js<span style="color: #61AFEF;">)</span>.value
<span class="linenr">47: </span>      <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">fullJs</span> <span style="color: #C678DD;">=</span> <span style="color: #61AFEF;">(</span>fullOptJS in <span style="color: #56B6C2;">Compile</span> in js<span style="color: #61AFEF;">)</span>.value.data
<span class="linenr">48: </span>      <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">fullJsSourceMap</span> <span style="color: #C678DD;">=</span> fullJs.getParentFile / <span style="color: #61AFEF;">(</span>fullJs.getName + <span style="color: #98C379;">".map"</span><span style="color: #61AFEF;">)</span>
<span class="linenr">49: </span>      <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">fullJsDeps</span> <span style="color: #C678DD;">=</span> <span style="color: #61AFEF;">(</span>packageMinifiedJSDependencies in <span style="color: #56B6C2;">Compile</span> in js<span style="color: #61AFEF;">)</span>.value
<span class="linenr">50: </span>
<span class="linenr">51: </span>      <span style="color: #C678DD;">for</span><span style="color: #61AFEF;">(</span>f <span style="color: #C678DD;">&lt;-</span> <span style="color: #56B6C2;">Seq</span><span style="color: #56B6C2;">(</span>fastJs, fastJsSourceMap, fastJsLauncher, fastJsDeps, fullJs, fullJsSourceMap, fullJsDeps<span style="color: #56B6C2;">)</span><span style="color: #61AFEF;">)</span> <span style="color: #61AFEF;">{</span>
<span class="linenr">52: </span>        <span style="color: #56B6C2;">IO</span>.copyFile<span style="color: #56B6C2;">(</span>f, to / f.getName<span style="color: #56B6C2;">)</span>
<span class="linenr">53: </span>      <span style="color: #61AFEF;">}</span>
<span class="linenr">54: </span>    <span style="color: #C678DD;">}</span>
<span class="linenr">55: </span>  <span style="color: #ABB2BF;">)</span>.
<span class="linenr">56: </span>  settings<span style="color: #ABB2BF;">(</span>
<span class="linenr">57: </span>    compile in <span style="color: #56B6C2;">Compile</span> := <span style="color: #C678DD;">{</span>
<span class="linenr">58: </span>      compileCopyTask.value
<span class="linenr">59: </span>      <span style="color: #61AFEF;">(</span>compile in <span style="color: #56B6C2;">Compile</span><span style="color: #61AFEF;">)</span>.value
<span class="linenr">60: </span>    <span style="color: #C678DD;">}</span>
<span class="linenr">61: </span>  <span style="color: #ABB2BF;">)</span>.
<span class="linenr">62: </span>  settings<span style="color: #ABB2BF;">(</span>
<span class="linenr">63: </span>    mainClass in assembly := <span style="color: #56B6C2;">Some</span><span style="color: #C678DD;">(</span><span style="color: #98C379;">"Server"</span><span style="color: #C678DD;">)</span>,
<span class="linenr">64: </span>    assemblyJarName in assembly := <span style="color: #98C379;">"server.jar"</span>
<span class="linenr">65: </span>  <span style="color: #ABB2BF;">)</span>
<span class="linenr">66: </span>
<span class="linenr">67: </span><span style="color: #56B6C2;">lazy</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">js</span> <span style="color: #C678DD;">=</span> <span style="color: #ABB2BF;">(</span>project in file<span style="color: #C678DD;">(</span><span style="color: #98C379;">"js"</span><span style="color: #C678DD;">)</span><span style="color: #ABB2BF;">)</span>.
<span class="linenr">68: </span>  settings<span style="color: #ABB2BF;">(</span>commonSettings<span style="color: #C678DD;">:</span> <span style="color: #C678DD;">_</span>*<span style="color: #ABB2BF;">)</span>.
<span class="linenr">69: </span>  settings<span style="color: #ABB2BF;">(</span>
<span class="linenr">70: </span>    mainClass in <span style="color: #C678DD;">(</span><span style="color: #56B6C2;">Compile</span><span style="color: #C678DD;">)</span> := <span style="color: #56B6C2;">Some</span><span style="color: #C678DD;">(</span><span style="color: #98C379;">"Application"</span><span style="color: #C678DD;">)</span>,
<span class="linenr">71: </span>    persistLauncher := <span style="color: #56B6C2;">true</span>,
<span class="linenr">72: </span>    libraryDependencies ++= <span style="color: #56B6C2;">Seq</span><span style="color: #C678DD;">(</span>
<span class="linenr">73: </span>      <span style="color: #98C379;">"org.scala-js"</span> %%% <span style="color: #98C379;">"scalajs-dom"</span> % <span style="color: #98C379;">"0.9.1"</span>,
<span class="linenr">74: </span>      <span style="color: #98C379;">"com.thoughtworks.binding"</span> %%% <span style="color: #98C379;">"dom"</span> % <span style="color: #56B6C2;">BindingScalaVersion</span>,
<span class="linenr">75: </span>      <span style="color: #98C379;">"com.thoughtworks.binding"</span> %%% <span style="color: #98C379;">"route"</span> % <span style="color: #56B6C2;">BindingScalaVersion</span>,
<span class="linenr">76: </span>      <span style="color: #98C379;">"io.circe"</span> %%% <span style="color: #98C379;">"circe-core"</span> % <span style="color: #56B6C2;">CirceVersion</span>,
<span class="linenr">77: </span>      <span style="color: #98C379;">"io.circe"</span> %%% <span style="color: #98C379;">"circe-parser"</span> % <span style="color: #56B6C2;">CirceVersion</span>,
<span class="linenr">78: </span>      <span style="color: #98C379;">"io.circe"</span> %%% <span style="color: #98C379;">"circe-generic"</span> % <span style="color: #56B6C2;">CirceVersion</span>,
<span class="linenr">79: </span>      <span style="color: #98C379;">"org.scalaz"</span> %%% <span style="color: #98C379;">"scalaz-core"</span> % <span style="color: #56B6C2;">ScalazVersion</span>
<span class="linenr">80: </span>    <span style="color: #C678DD;">)</span>
<span class="linenr">81: </span>  <span style="color: #ABB2BF;">)</span>.
<span class="linenr">82: </span>  enablePlugins<span style="color: #ABB2BF;">(</span><span style="color: #56B6C2;">ScalaJSPlugin</span><span style="color: #ABB2BF;">)</span>
</pre>
</div>

<p>
增加 <code>server</code> submodule
</p>

<div class="org-src-container">
<pre class="src src-shell">mkdir -p server/src/<span style="color: #ABB2BF;">{</span>main,test<span style="color: #ABB2BF;">}</span>/<span style="color: #ABB2BF;">{</span>scala,resources<span style="color: #ABB2BF;">}</span>
</pre>
</div>

<p>
增加 <code>Server.scala</code>
</p>

<div class="org-src-container">
<pre class="src src-scala"><span class="linenr"> 1: </span><span style="color: #C678DD;">import</span> java.util.concurrent.<span style="color: #56B6C2;">CountDownLatch</span>
<span class="linenr"> 2: </span><span style="color: #C678DD;">import</span> akka.actor.<span style="color: #56B6C2;">ActorSystem</span>
<span class="linenr"> 3: </span><span style="color: #C678DD;">import</span> akka.stream.<span style="color: #56B6C2;">ActorMaterializer</span>
<span class="linenr"> 4: </span><span style="color: #C678DD;">import</span> akka.http.scaladsl.<span style="color: #56B6C2;">Http</span>
<span class="linenr"> 5: </span><span style="color: #C678DD;">import</span> akka.http.scaladsl.server.<span style="color: #56B6C2;">Directives</span>.<span style="color: #C678DD;">_</span>
<span class="linenr"> 6: </span><span style="color: #C678DD;">import</span> com.typesafe.config.<span style="color: #56B6C2;">ConfigFactory</span>
<span class="linenr"> 7: </span><span style="color: #C678DD;">import</span> com.typesafe.scalalogging.<span style="color: #56B6C2;">Logger</span>
<span class="linenr"> 8: </span><span style="color: #C678DD;">import</span> scala.concurrent.<span style="color: #56B6C2;">Await</span>
<span class="linenr"> 9: </span><span style="color: #C678DD;">import</span> scala.concurrent.duration.<span style="color: #C678DD;">_</span>
<span class="linenr">10: </span>
<span class="linenr">11: </span><span style="color: #C678DD;">object</span> <span style="color: #56B6C2;">Server</span> <span style="color: #C678DD;">extends</span> <span style="color: #E5C07B;">App</span> <span style="color: #ABB2BF;">{</span>
<span class="linenr">12: </span>  <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">logger</span> <span style="color: #C678DD;">=</span> <span style="color: #56B6C2;">Logger</span><span style="color: #C678DD;">(</span><span style="color: #56B6C2;">Server</span>.getClass<span style="color: #C678DD;">)</span>
<span class="linenr">13: </span>  <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">conf</span> <span style="color: #C678DD;">=</span> <span style="color: #56B6C2;">ConfigFactory</span>.load<span style="color: #C678DD;">()</span>.withFallback<span style="color: #C678DD;">(</span><span style="color: #56B6C2;">ConfigFactory</span>.load<span style="color: #61AFEF;">(</span><span style="color: #98C379;">"default.conf"</span><span style="color: #61AFEF;">)</span><span style="color: #C678DD;">)</span>
<span class="linenr">14: </span>
<span class="linenr">15: </span>  <span style="color: #56B6C2;">implicit</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">actorSystem</span> <span style="color: #C678DD;">=</span> <span style="color: #56B6C2;">ActorSystem</span><span style="color: #C678DD;">()</span>
<span class="linenr">16: </span>  <span style="color: #56B6C2;">implicit</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">materializer</span> <span style="color: #C678DD;">=</span> <span style="color: #56B6C2;">ActorMaterializer</span><span style="color: #C678DD;">()</span>
<span class="linenr">17: </span>  <span style="color: #56B6C2;">implicit</span> <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">executionContext</span> <span style="color: #C678DD;">=</span> actorSystem.dispatcher
<span class="linenr">18: </span>
<span class="linenr">19: </span>  <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">shutdownLatch</span> <span style="color: #C678DD;">=</span> <span style="color: #C678DD;">new</span> <span style="color: #E5C07B;">CountDownLatch</span><span style="color: #C678DD;">(</span><span style="color: #56B6C2;">1</span><span style="color: #C678DD;">)</span>
<span class="linenr">20: </span>
<span class="linenr">21: </span>  <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">devRoute</span> <span style="color: #C678DD;">=</span> pathSingleSlash <span style="color: #C678DD;">{</span>
<span class="linenr">22: </span>    parameter<span style="color: #61AFEF;">(</span><span style="color: #98C379;">"fast"</span><span style="color: #61AFEF;">)</span> <span style="color: #61AFEF;">{</span> <span style="color: #C678DD;">_</span> <span style="color: #C678DD;">=&gt;</span>
<span class="linenr">23: </span>      getFromFile<span style="color: #56B6C2;">(</span><span style="color: #98C379;">"./src/main/resources/static/index-fastopt.html"</span><span style="color: #56B6C2;">)</span>
<span class="linenr">24: </span>    <span style="color: #61AFEF;">}</span> ~
<span class="linenr">25: </span>      getFromFile<span style="color: #61AFEF;">(</span><span style="color: #98C379;">"./src/main/resources/static/index-fullopt.html"</span><span style="color: #61AFEF;">)</span>
<span class="linenr">26: </span>  <span style="color: #C678DD;">}</span> ~
<span class="linenr">27: </span>    encodeResponse <span style="color: #C678DD;">{</span>
<span class="linenr">28: </span>      getFromDirectory<span style="color: #61AFEF;">(</span><span style="color: #98C379;">"./src/main/resources/static"</span><span style="color: #61AFEF;">)</span> ~
<span class="linenr">29: </span>        pathPrefix<span style="color: #61AFEF;">(</span><span style="color: #98C379;">"js"</span><span style="color: #61AFEF;">)</span> <span style="color: #61AFEF;">{</span>
<span class="linenr">30: </span>          getFromDirectory<span style="color: #56B6C2;">(</span><span style="color: #98C379;">"../js/target/scala-2.11"</span><span style="color: #56B6C2;">)</span>
<span class="linenr">31: </span>        <span style="color: #61AFEF;">}</span>
<span class="linenr">32: </span>    <span style="color: #C678DD;">}</span>
<span class="linenr">33: </span>
<span class="linenr">34: </span>  <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">productionRoute</span> <span style="color: #C678DD;">=</span> pathSingleSlash <span style="color: #C678DD;">{</span>
<span class="linenr">35: </span>    parameter<span style="color: #61AFEF;">(</span><span style="color: #98C379;">"fast"</span><span style="color: #61AFEF;">)</span> <span style="color: #61AFEF;">{</span> <span style="color: #C678DD;">_</span> <span style="color: #C678DD;">=&gt;</span>
<span class="linenr">36: </span>      getFromResource<span style="color: #56B6C2;">(</span><span style="color: #98C379;">"static/index-fastopt.html"</span><span style="color: #56B6C2;">)</span>
<span class="linenr">37: </span>    <span style="color: #61AFEF;">}</span> ~
<span class="linenr">38: </span>      getFromResource<span style="color: #61AFEF;">(</span><span style="color: #98C379;">"static/index-fullopt.html"</span><span style="color: #61AFEF;">)</span>
<span class="linenr">39: </span>  <span style="color: #C678DD;">}</span> ~
<span class="linenr">40: </span>    encodeResponse <span style="color: #C678DD;">{</span>
<span class="linenr">41: </span>      getFromResourceDirectory<span style="color: #61AFEF;">(</span><span style="color: #98C379;">"static"</span><span style="color: #61AFEF;">)</span>
<span class="linenr">42: </span>    <span style="color: #C678DD;">}</span>
<span class="linenr">43: </span>
<span class="linenr">44: </span>  <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">host</span> <span style="color: #C678DD;">=</span> conf.getString<span style="color: #C678DD;">(</span><span style="color: #98C379;">"server.host"</span><span style="color: #C678DD;">)</span>
<span class="linenr">45: </span>  <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">port</span> <span style="color: #C678DD;">=</span> conf.getInt<span style="color: #C678DD;">(</span><span style="color: #98C379;">"server.port"</span><span style="color: #C678DD;">)</span>
<span class="linenr">46: </span>  <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">bindingFuture</span> <span style="color: #C678DD;">=</span> <span style="color: #56B6C2;">Http</span><span style="color: #C678DD;">()</span>.bindAndHandle<span style="color: #C678DD;">(</span>devRoute ~ productionRoute, host, port<span style="color: #C678DD;">)</span>
<span class="linenr">47: </span>  logger.info<span style="color: #C678DD;">(</span>s<span style="color: #98C379;">"Server online as http://</span><span style="color: #E06C75;">${host}</span><span style="color: #98C379;">:</span><span style="color: #E06C75;">${port}</span><span style="color: #98C379;">"</span><span style="color: #C678DD;">)</span>
<span class="linenr">48: </span>
<span class="linenr">49: </span>  <span style="color: #56B6C2;">Runtime</span>.getRuntime<span style="color: #C678DD;">()</span>.addShutdownHook<span style="color: #C678DD;">(</span><span style="color: #C678DD;">new</span> <span style="color: #E5C07B;">Thread</span><span style="color: #61AFEF;">()</span> <span style="color: #61AFEF;">{</span>
<span class="linenr">50: </span>    <span style="color: #56B6C2;">override</span> <span style="color: #C678DD;">def</span> <span style="color: #61AFEF;">run</span><span style="color: #56B6C2;">()</span> <span style="color: #C678DD;">=</span> <span style="color: #56B6C2;">{</span>
<span class="linenr">51: </span>      <span style="color: #C678DD;">val</span> <span style="color: #E06C75;">f</span> <span style="color: #C678DD;">=</span> bindingFuture.flatMap<span style="color: #98C379;">(</span><span style="color: #C678DD;">_</span>.unbind<span style="color: #D19A66;">()</span><span style="color: #98C379;">)</span> andThen <span style="color: #98C379;">{</span>
<span class="linenr">52: </span>        <span style="color: #C678DD;">case</span> <span style="color: #C678DD;">_</span> <span style="color: #C678DD;">=&gt;</span> actorSystem.terminate<span style="color: #D19A66;">()</span>
<span class="linenr">53: </span>      <span style="color: #98C379;">}</span>
<span class="linenr">54: </span>      <span style="color: #56B6C2;">Await</span>.ready<span style="color: #98C379;">(</span>f, <span style="color: #56B6C2;">1</span> minute<span style="color: #98C379;">)</span>
<span class="linenr">55: </span>      logger.info<span style="color: #98C379;">(</span><span style="color: #98C379;">"Goodbye!"</span><span style="color: #98C379;">)</span>
<span class="linenr">56: </span>      shutdownLatch.countDown<span style="color: #98C379;">()</span>
<span class="linenr">57: </span>    <span style="color: #56B6C2;">}</span>
<span class="linenr">58: </span>  <span style="color: #61AFEF;">}</span><span style="color: #C678DD;">)</span>
<span class="linenr">59: </span>
<span class="linenr">60: </span>  shutdownLatch.await<span style="color: #C678DD;">()</span>
<span class="linenr">61: </span><span style="color: #ABB2BF;">}</span>
</pre>
</div>

<p>
现在只要执行，=sbt server/run= ，然后在浏览器中访问 <code>http://127.0.0.1:1234/?fast</code> 或者 <code>http://127.0.0.1:1234/</code> 就能分别访问 <code>fastOptJS</code> 或者 <code>fullOptJS</code> 的js了。
</p>

<p>
好了这只是一个准备工作，接下来是 <code>Binding.scala</code> 的哲学时间。
</p>


    <div>
      <div class="post-meta">
        <span title="post date" class="post-info">2016-12-31</span>
        <span title="last modification date" class="post-info">2017-01-14</span>
        <span title="tags" class="post-info"><a href="/tags/javascript/">javascript</a>, <a href="/tags/scala.js/">scala.js</a>, <a href="/tags/scala/">scala</a></span>
        <span title="author" class="post-info">Shane Xu</span>
      </div>
      <section>
        <h2 class="chapter">Comments</h2>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          //var disqus_developer = 1;
          var disqus_identifier = "/blog/2016/12/31/binding.scala-in-practice";
          var disqus_url = "http://xusheng.org/blog/2016/12/31/binding.scala-in-practice";
          var disqus_shortname = 'shanexu';
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="//disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </section>
      <script src="/media/js/main.js"></script>
        <script type="text/javascript">
         var _gaq = _gaq || [];
         _gaq.push(['_setAccount', 'UA-74684473-1']);
         _gaq.push(['_trackPageview']);
         (function() {
           var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
           ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
           var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
         })();
        </script>
      <div class="footer">
        <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
        <p>
          Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:xusheng0711@gmail.com">Shane Xu</a>
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
      </div>
    </div>

  </body>
</html>
